<!doctype html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="学无止境">
<meta property="og:type" content="website">
<meta property="og:title" content="Refrain">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Refrain">
<meta property="og:description" content="学无止境">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Refrain">
<meta name="twitter:description" content="学无止境">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Refrain</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Refrain</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/21/YARN调度器相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/21/YARN调度器相关/" itemprop="url">YARN调度器相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-21T17:07:35+08:00">
                2017-08-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题-YARN有哪些调度器"><a href="#问题-YARN有哪些调度器" class="headerlink" title="问题: YARN有哪些调度器"></a>问题: YARN有哪些调度器</h3><ul>
<li>FIFO</li>
<li>Capacity</li>
<li>Fair</li>
</ul>
<p>2.0.2-alpha 版本之前，默认的调度器为FIFO，之后默认的调度器为Capacity<br>现在Apache、HDP默认使用Capacity<br>CDH、MapR默认使用Fair</p>
<h3 id="问题-如何更换yarn调度器"><a href="#问题-如何更换yarn调度器" class="headerlink" title="问题: 如何更换yarn调度器"></a>问题: 如何更换yarn调度器</h3><p>yarn-site.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># Capacity</div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.scheduler.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"># Fair</div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.scheduler.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.FairScheduler<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="问题-Capacity调度器是什么"><a href="#问题-Capacity调度器是什么" class="headerlink" title="问题: Capacity调度器是什么"></a>问题: Capacity调度器是什么</h3><p>Capacity调度器允许多个组织共享整个集群，每个组织可以获得集群的一部分计算能力。<br>通过为每个组织分配专门的 <strong>队列</strong>，然后再为每个队列分配一定的集群资源，这样整个集群就可以通过设置多个队列的方式给多个组织提供服务了。<br>在一个队列内部，资源的调度是采用的是先进先出(FIFO)策略</p>
<p>假设有如下层次队列:</p>
<ul>
<li>root<ul>
<li>prod <1.0></1.0></li>
<li>dev <1.1><ul>
<li>eng <1.1.0></1.1.0></li>
<li>science <1.1.1></1.1.1></li>
</ul>
</1.1></li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">&lt;!-- capacity-scheduler.xml 配置如下 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>prod,dev<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">    The queues at the this level (root is the root queue).</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.dev.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>eng,science<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.prod.capacity<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>60<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">    The maximum capacity of the prod queue.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.dev.capacity<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>40<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">    The maximum capacity of the dev queue.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.dev.maximun-capacity<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>75<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">    dev所能用的最大资源比例只能达到75%, 用不到完整的集群资源</div><div class="line">    PS. 如果队列没有配置此项，该队列可能用到集群所有资源</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="问题-Fair调度器是什么"><a href="#问题-Fair调度器是什么" class="headerlink" title="问题: Fair调度器是什么"></a>问题: Fair调度器是什么</h3><p>Fair调度器的设计目标是为所有的应用分配公平的资源<br>假设有两个用户A和B，他们分别拥有一个队列。当A启动一个job而B没有任务时，A会获得全部集群资源；<br>当B启动一个job后，A的job会继续运行，不过一会儿之后两个任务会各自获得一半的集群资源。<br>如果此时B再启动第二个job并且其它job还在运行，则它将会和B的第一个job共享B这个队列的资源，也就是B的两个job会用于四分之一的集群资源，而A的job仍然用于集群一半的资源，结果就是资源最终在两个用户之间平等的共享<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">allocations</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">defaultQueueShedulingPolicy</span>&gt;</span>fair<span class="tag">&lt;/<span class="name">defaultQueueShedulingPolicy</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">queue</span> <span class="attr">name</span>=<span class="string">"prod"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>40<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">schedulingPolicy</span>&gt;</span>fifo<span class="tag">&lt;/<span class="name">schedulingPolicy</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">queue</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">queue</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>60<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">queue</span> <span class="attr">name</span>=<span class="string">"eng"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">queue</span> <span class="attr">name</span>=<span class="string">"science"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">queue</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">queuePlacementPolicy</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">name</span>=<span class="string">"specified"</span> <span class="attr">create</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">name</span>=<span class="string">"primaryGroup"</span> <span class="attr">create</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">name</span>=<span class="string">"default"</span> <span class="attr">create</span>=<span class="string">"dev.eng"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">queuePlacementPolicy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">allocations</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="问题-Capacity与Fair调度器的比较"><a href="#问题-Capacity与Fair调度器的比较" class="headerlink" title="问题: Capacity与Fair调度器的比较"></a>问题: Capacity与Fair调度器的比较</h3><table>
<thead>
<tr>
<th></th>
<th>Capacity调度器</th>
<th>Fair调度器</th>
</tr>
</thead>
<tbody>
<tr>
<td>层级队列</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>资源调度策略</td>
<td>队列之间：通过队列使用容量进行排序 队列内部：FIFO（支持主资源计算）</td>
<td>队列之间：支持FIFO,FAIR,DRF 队列内部：支持FIFO,FAIR,DRF</td>
</tr>
<tr>
<td>抢占</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>延迟调度</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>资源的限制</td>
<td>可设置队列最小，最大资源的百分比, 可设置队列每个用户的资源的百分比，可设置队列运行App资源的百分比、个数</td>
<td>可设置队列最小资源数量, 可设置队列最大资源数量, 可设置队列运行App个数, 可设置队列的权重</td>
</tr>
<tr>
<td>批量调度</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>禁用队列</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody>
</table>
<p>参考文档：<br><a href="http://www.mamicode.com/info-detail-1097801.html" target="_blank" rel="external">http://www.mamicode.com/info-detail-1097801.html</a><br><a href="http://dongxicheng.org/mapreduce-nextgen/hadoop-yarn-configurations-capacity-scheduler/" target="_blank" rel="external">http://dongxicheng.org/mapreduce-nextgen/hadoop-yarn-configurations-capacity-scheduler/</a><br><a href="http://dongxicheng.org/mapreduce-nextgen/hadoop-yarn-configurations-fair-scheduler/" target="_blank" rel="external">http://dongxicheng.org/mapreduce-nextgen/hadoop-yarn-configurations-fair-scheduler/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/16/Hive中Reduce执行时间不同问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/16/Hive中Reduce执行时间不同问题/" itemprop="url">Hive中Reduce执行时间不同问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-16T21:07:55+08:00">
                2017-08-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题-查看Job是否出现数据倾斜"><a href="#问题-查看Job是否出现数据倾斜" class="headerlink" title="问题: 查看Job是否出现数据倾斜"></a>问题: 查看Job是否出现数据倾斜</h3><h4 id="查看reduce-task最长和最短执行时间"><a href="#查看reduce-task最长和最短执行时间" class="headerlink" title="查看reduce task最长和最短执行时间"></a>查看reduce task最长和最短执行时间</h4><img src="/images/201708/reduce_time_0.png">
<img src="/images/201708/reduce_time_1.png">
<img src="/images/201708/reduce_time_2.png">
<p>如上图所示，task执行最长时间为3分56秒，最短时间为10秒，可能出现数据倾斜</p>
<h4 id="查看最长和最短执行时间的reduce输入量"><a href="#查看最长和最短执行时间的reduce输入量" class="headerlink" title="查看最长和最短执行时间的reduce输入量"></a>查看最长和最短执行时间的reduce输入量</h4><img src="/images/201708/reduce_tasks_0.png">
<img src="/images/201708/reduce_tasks_1.png">
<img src="/images/201708/reduce_tasks_2.png">
<p><strong>输入量差异比较大，则出现了数据倾斜的情况</strong></p>
<h3 id="问题-定位出现数据倾斜的地方"><a href="#问题-定位出现数据倾斜的地方" class="headerlink" title="问题: 定位出现数据倾斜的地方"></a>问题: 定位出现数据倾斜的地方</h3><h4 id="找到造成数据倾斜的key"><a href="#找到造成数据倾斜的key" class="headerlink" title="找到造成数据倾斜的key"></a>找到造成数据倾斜的key</h4><ul>
<li>找到任务特别慢的那个task，打开对应日志</li>
<li>搜索日志中出现的”rows for joinkey”</li>
<li>找到时间跨度最大的那条记录</li>
</ul>
<h4 id="确定任务卡住的stage"><a href="#确定任务卡住的stage" class="headerlink" title="确定任务卡住的stage"></a>确定任务卡住的stage</h4><ul>
<li>确定stage (通过Job下Overview中Job Name)</li>
<li>确定SQL &lt;通过Job下Configuration搜索hive.query.string)</li>
<li>找到对应的stage，查看具体执行计划 (explain extend该SQL)</li>
<li>确定SQL执行代码</li>
</ul>
<h3 id="问题：解决数据倾斜问题"><a href="#问题：解决数据倾斜问题" class="headerlink" title="问题：解决数据倾斜问题"></a>问题：解决数据倾斜问题</h3><ul>
<li>过滤掉脏数据</li>
<li>hive.optimize.skewjoin</li>
<li>调大内存</li>
<li>mapjoin</li>
<li>大key单独处理</li>
</ul>
<h3 id="PS"><a href="#PS" class="headerlink" title="PS."></a>PS.</h3><p><strong>问题纪录：</strong> 同一个JOB，reduce task执行时间差很多，但是reduce的输入量差不多<br><strong>原因：</strong> mapreduce.job.reduce.slowstart.completedmaps(当Map Task完成的比例达到该值后才会为Reduce Task申请资源)<br>使用的默认的参数0.05<br>在集群资源不足并且任务的输入量很大的情况，Reduce过早的进行Copy操作，会占用资源，导致资源不足，新的Map执行不了(类似死锁)，最后AM会kill掉Reduce，导致某些Reduce执行时间过长<br><strong>解决办法:</strong> 提高mapreduce.job.reduce.slowstart.completedmaps该参数的值</p>
<p>参考文档: <a href="https://mp.weixin.qq.com/s/ye4PUxgakf-l-32TZ92uew" target="_blank" rel="external">https://mp.weixin.qq.com/s/ye4PUxgakf-l-32TZ92uew</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/15/YARN集群资源相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/15/YARN集群资源相关/" itemprop="url">YARN集群资源相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-15T20:51:59+08:00">
                2017-08-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>问题: 给你一个集群，该如何对资源进行合理分配</strong></p>
<h3 id="总资源"><a href="#总资源" class="headerlink" title="总资源"></a>总资源</h3><p>集群中每台机器的配置 (RAM,CPU,Disk,网卡)</p>
<h3 id="预留资源"><a href="#预留资源" class="headerlink" title="预留资源"></a>预留资源</h3><p>总资源 - 集群中运行服务需要的资源(操作系统OS,DataNode,NodeManger,HBase,Hive,ZK,Impala..)</p>
<h3 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h3><h4 id="YARN分配资源-主要参数"><a href="#YARN分配资源-主要参数" class="headerlink" title="YARN分配资源 主要参数:"></a>YARN分配资源 主要参数:</h4><p>yarn.nodemanager.resource.memory-mb 每个节点分配的内存<br>yarn.nodemanager.resource.cpu-vcores 每个节点分配的虚拟CPU<br><img src="/images/201708/yarn_resource_1.png"><br><img src="/images/201708/yarn_resource_2.png"></p>
<h4 id="YARN资源调度分配-主要参数"><a href="#YARN资源调度分配-主要参数" class="headerlink" title="YARN资源调度分配 主要参数:"></a>YARN资源调度分配 主要参数:</h4><p>yarn.scheduler.minimum-allocation-mb container最少内存<br>yarn.scheduler.maximum-allocation-mb container最大内存&lt;限制分配资源大小&gt;</p>
<h4 id="Determine-HDP-Memory-Configuration-Settings"><a href="#Determine-HDP-Memory-Configuration-Settings" class="headerlink" title="Determine HDP Memory Configuration Settings"></a>Determine HDP Memory Configuration Settings</h4><p><a href="https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.0/bk_installing_manually_book/content/determine-hdp-memory-config.html" target="_blank" rel="external">https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.0/bk_installing_manually_book/content/determine-hdp-memory-config.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">python hdp-configuration-utils.py -c 12 -m 48 <span class="_">-d</span> 12 -k False</div><div class="line"> Using cores=12 memory=48GB disks=12 hbase=False</div><div class="line"> Profile: cores=12 memory=43008MB reserved=6GB usableMem=42GB disks=12</div><div class="line"> Num Container=21</div><div class="line"> Container Ram=2048MB</div><div class="line"> Used Ram=42GB</div><div class="line"> Unused Ram=6GB</div><div class="line"> ***** mapred-site.xml *****</div><div class="line"> mapreduce.map.memory.mb=2048</div><div class="line"> mapreduce.map.java.opts=-Xmx1536m</div><div class="line"> mapreduce.reduce.memory.mb=2048</div><div class="line"> mapreduce.reduce.java.opts=-Xmx1536m</div><div class="line"> mapreduce.task.io.sort.mb=768</div><div class="line"> ***** yarn-site.xml *****</div><div class="line"> yarn.scheduler.minimum-allocation-mb=2048</div><div class="line"> yarn.scheduler.maximum-allocation-mb=43008</div><div class="line"> yarn.nodemanager.resource.memory-mb=43008</div><div class="line"> yarn.app.mapreduce.am.resource.mb=2048</div><div class="line"> yarn.app.mapreduce.am.command-opts=-Xmx1536m</div><div class="line"> ***** tez-site.xml *****</div><div class="line"> tez.am.resource.memory.mb=2048</div><div class="line"> tez.am.java.opts=-Xmx1536m</div><div class="line"> ***** hive-site.xml *****</div><div class="line"> hive.tez.container.size=2048</div><div class="line"> hive.tez.java.opts=-Xmx1536m</div><div class="line"> hive.auto.convert.join.noconditionaltask.size=402653000</div></pre></td></tr></table></figure></p>
<h3 id="其他注意项"><a href="#其他注意项" class="headerlink" title="其他注意项"></a>其他注意项</h3><h4 id="虚拟内存和物理内存检查"><a href="#虚拟内存和物理内存检查" class="headerlink" title="虚拟内存和物理内存检查"></a>虚拟内存和物理内存检查</h4><p>NodeManager 可以监控Container的虚拟和物理内存使用情况<br>一般都会关闭虚拟内存检查<br><img src="/images/201708/yarn_resource_3.png"></p>
<h4 id="Set-Xmx-of-java-opts-of-each-container-to-0-8-container-memory-allocation"><a href="#Set-Xmx-of-java-opts-of-each-container-to-0-8-container-memory-allocation" class="headerlink" title="Set -Xmx of java-opts of each container to 0.8 * (container memory allocation)"></a>Set -Xmx of java-opts of each container to 0.8 * (container memory allocation)</h4><img src="/images/201708/yarn_resource_4.png">
<img src="/images/201708/yarn_resource_5.png">
<img src="/images/201708/yarn_resource_6.png">
<h4 id="Bottleneck-resource-瓶颈资源"><a href="#Bottleneck-resource-瓶颈资源" class="headerlink" title="Bottleneck resource 瓶颈资源"></a>Bottleneck resource 瓶颈资源</h4><p>Since there are three types of resources, different containers from different jobs may ask for different amount of resources. This can result in one of the resources becoming the bottleneck. Suppose we have a cluster with capacity (1000G RAM,16 Cores,16 disks) and each Mapper container needs (10G RAM,1 Core, 0.5 disks): at most, 16 Mappers can run in parallel because CPU cores become the bottleneck here.<br>As a result, (840G RAM, 8 disks) resources are not used by anyone. If you meet this situation, just check the RM UI(<a href="http://:8088/cluster/nodes" target="_blank" rel="external">http://:8088/cluster/nodes</a>) to figure out which resource is the bottleneck. You can probably allocate the leftover resources to jobs which can improve performance with such resource. For example, you can allocate more memory to sorting jobs which used to spill to disk.</p>
<p>参考文档:<br><a href="https://mapr.com/blog/best-practices-yarn-resource-management/" target="_blank" rel="external">https://mapr.com/blog/best-practices-yarn-resource-management/</a><br><a href="https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.0/bk_installing_manually_book/content/determine-hdp-memory-config.html" target="_blank" rel="external">https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.3.0/bk_installing_manually_book/content/determine-hdp-memory-config.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/记录1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/记录1/" itemprop="url">记录1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T17:57:47+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="hive-更改字段类型"><a href="#hive-更改字段类型" class="headerlink" title="hive 更改字段类型"></a>hive 更改字段类型</h2><h3 id="无分区表"><a href="#无分区表" class="headerlink" title="无分区表"></a>无分区表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `tb_dw_cu_mimsg_fbi_servdt_day1`(</div><div class="line">  `mimsg_serv` int COMMENT &apos;微信服务量&apos;</div><div class="line">)</div><div class="line">ROW FORMAT DELIMITED FIELDS TERMINATED BY &apos;|&apos;;</div><div class="line"></div><div class="line">insert overwrite table tb_dw_cu_mimsg_fbi_servdt_day1 values(1.02);</div><div class="line"></div><div class="line">hive&gt; select * from tb_dw_cu_mimsg_fbi_servdt_day1;</div><div class="line"></div><div class="line">1</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 修改表结构</div><div class="line">ALTER TABLE tb_dw_cu_mimsg_fbi_servdt_day1 REPLACE COLUMNS (mimsg_serv DECIMAL(5,2));</div><div class="line"></div><div class="line">insert overwrite table tb_dw_cu_mimsg_fbi_servdt_day1 values(1.02);</div><div class="line"></div><div class="line">hive&gt; select * from tb_dw_cu_mimsg_fbi_servdt_day1;</div><div class="line"></div><div class="line">1.02</div></pre></td></tr></table></figure>
<h3 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `tb_dw_cu_mimsg_fbi_servdt_day1`(</div><div class="line">  `mimsg_serv` int COMMENT &apos;微信服务量&apos;)</div><div class="line">PARTITIONED BY (</div><div class="line">  `statis_date` varchar(8))</div><div class="line">ROW FORMAT DELIMITED</div><div class="line">  FIELDS TERMINATED BY &apos;|&apos; ;</div><div class="line"></div><div class="line">insert overwrite table tb_dw_cu_mimsg_fbi_servdt_day1 partition (statis_date=20160501) values(1.02);</div><div class="line"></div><div class="line">hive&gt; select * from tb_dw_cu_mimsg_fbi_servdt_day1;</div><div class="line"></div><div class="line">1    20160501</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 正确的修改分区表结构</div><div class="line">ALTER TABLE tb_dw_cu_mimsg_fbi_servdt_day1 PARTITION (statis_date) CHANGE COLUMN mimsg_serv mimsg_serv DECIMAL(5,2);</div><div class="line"></div><div class="line">insert overwrite table tb_dw_cu_mimsg_fbi_servdt_day1 partition (statis_date=20160501) values(1.02);</div><div class="line"></div><div class="line">hive&gt; select * from tb_dw_cu_mimsg_fbi_servdt_day1;</div><div class="line"></div><div class="line">1.02    20160501</div></pre></td></tr></table></figure>
<h2 id="hive-增加字段"><a href="#hive-增加字段" class="headerlink" title="hive 增加字段"></a>hive 增加字段</h2><p><em>还是用之前的表</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">alter table tb_dw_cu_mimsg_fbi_servdt_day1 add COLUMNS (prov_code varchar(5));</div><div class="line"></div><div class="line">hive&gt; select * from tb_dw_cu_mimsg_fbi_servdt_day1;</div><div class="line"></div><div class="line">1.02    NULL    20160501</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">insert overwrite table tb_dw_cu_mimsg_fbi_servdt_day1 partition(statis_date=20160501) values (2.01,0371);</div><div class="line"></div><div class="line">hive&gt; select * from tb_dw_cu_mimsg_fbi_servdt_day1;</div><div class="line"></div><div class="line">2.01    NULL    20160501</div></pre></td></tr></table></figure>
<p><em>数据没有更新成功</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 正确的更改表结构</div><div class="line">alter table tb_dw_cu_mimsg_fbi_servdt_day1 replace COLUMNS (mimsg_serv  decimal(5,2),prov_code varchar(5)) CASCADE;</div></pre></td></tr></table></figure>
<p>参考文档: <a href="http://blog.csdn.net/windyqcf/article/details/51488139" target="_blank" rel="external">http://blog.csdn.net/windyqcf/article/details/51488139</a></p>
<h2 id="Hadoop平台关闭THP解决服务器高负载问题"><a href="#Hadoop平台关闭THP解决服务器高负载问题" class="headerlink" title="Hadoop平台关闭THP解决服务器高负载问题"></a>Hadoop平台关闭THP解决服务器高负载问题</h2><p>如果不关闭THP，发现Hadoop的系统态CPU使用率很高，</p>
<p>原因是RHEL6优化了内存申请的效率，而且在某些场景下对KVM的性能有明显提升。</p>
<p>而Hadoop是个高密集型内存运算系统，这个改动似乎给它带来了副作用。理论上运算型Java程序应该更多的使用用户态CPU才对，Cloudera官方也推荐关闭THP。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#关闭 THP(Transparent HugePages )</span></div><div class="line"><span class="comment"># for hadoop , disable thp</span></div><div class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</div><div class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/defrag</div></pre></td></tr></table></figure>
<p>参考文档: <a href="http://blog.csdn.net/levy_cui/article/details/51143125" target="_blank" rel="external">http://blog.csdn.net/levy_cui/article/details/51143125</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/21/hive问题记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/21/hive问题记录/" itemprop="url">hive问题记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-21T10:59:53+08:00">
                2017-07-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1、HIVE-13632-gt-Hive-failing-on-insert-empty-array-into-parquet-table"><a href="#1、HIVE-13632-gt-Hive-failing-on-insert-empty-array-into-parquet-table" class="headerlink" title="1、HIVE-13632 -&gt; Hive failing on insert empty array into parquet table"></a>1、HIVE-13632 -&gt; Hive failing on insert empty array into parquet table</h3><p>报错如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">by: parquet.io.ParquetEncodingException: empty fields are illegal, the field should be ommited completely instead</div><div class="line">at parquet.io.MessageColumnIO$MessageColumnIORecordConsumer.endField(MessageColumnIO.java:<span class="number">271</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.DataWritableWriter$ListDataWriter.write(DataWritableWriter.java:<span class="number">271</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.DataWritableWriter$GroupDataWriter.write(DataWritableWriter.java:<span class="number">199</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.DataWritableWriter$MessageDataWriter.write(DataWritableWriter.java:<span class="number">215</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.DataWritableWriter.write(DataWritableWriter.java:<span class="number">88</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.DataWritableWriteSupport.write(DataWritableWriteSupport.java:<span class="number">59</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.DataWritableWriteSupport.write(DataWritableWriteSupport.java:<span class="number">31</span>)</div><div class="line">at parquet.hadoop.InternalParquetRecordWriter.write(InternalParquetRecordWriter.java:<span class="number">116</span>)</div><div class="line">at parquet.hadoop.ParquetRecordWriter.write(ParquetRecordWriter.java:<span class="number">123</span>)</div><div class="line">at parquet.hadoop.ParquetRecordWriter.write(ParquetRecordWriter.java:<span class="number">42</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.ParquetRecordWriterWrapper.write(ParquetRecordWriterWrapper.java:<span class="number">111</span>)</div><div class="line">at org.apache.hadoop.hive.ql.io.parquet.write.ParquetRecordWriterWrapper.write(ParquetRecordWriterWrapper.java:<span class="number">124</span>)</div><div class="line">at org.apache.hadoop.hive.ql.exec.FileSinkOperator.processOp(FileSinkOperator.java:<span class="number">697</span>)</div></pre></td></tr></table></figure></p>
<p>解决办法:<br>insert overwrite table test_table select <strong>if(size(array_column)=0, null, array_column)</strong> from src limit 1</p>
<p>参考: <a href="https://issues.apache.org/jira/browse/HIVE-13632" target="_blank" rel="external">https://issues.apache.org/jira/browse/HIVE-13632</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/01/Hue安装配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/01/Hue安装配置/" itemprop="url">Hue安装配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-01T20:42:47+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="下载Hue"><a href="#下载Hue" class="headerlink" title="下载Hue"></a>下载Hue</h3><p><a href="http://gethue.com/category/release/" target="_blank" rel="external">http://gethue.com/category/release/</a></p>
<h3 id="解压Hue安装包"><a href="#解压Hue安装包" class="headerlink" title="解压Hue安装包"></a>解压Hue安装包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar -xzvf hue-3.11.0.tgz</div><div class="line"><span class="built_in">cd</span> hue-3.11.0</div><div class="line"><span class="comment">#下载依赖</span></div><div class="line">sudo yum install apache-maven ant asciidoc cyrus-sasl-devel cyrus-sasl-gssapi gcc gcc-c++ krb5-devel libxml2-devel libxslt-devel make mysql mysql-devel openldap-devel python-devel sqlite-devel gmp-devel</div><div class="line">make apps</div></pre></td></tr></table></figure>
<h3 id="修改Hue配置"><a href="#修改Hue配置" class="headerlink" title="修改Hue配置"></a>修改Hue配置</h3><p>vim ./hue-3.11.0/desktop/conf/hue.ini<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1</span></div><div class="line">  time_zone=Asia/Shanghai</div><div class="line"><span class="comment"># 2</span></div><div class="line">  [[database]]</div><div class="line">    engine=mysql</div><div class="line">    host=xxx.xxx.xxx.xxx</div><div class="line">    port=3306</div><div class="line">    user=xxx</div><div class="line">    password=xxx</div><div class="line">    <span class="comment"># Execute this script to produce the database password. This will be used when 'password' is not set.</span></div><div class="line">    <span class="comment">## password_script=/path/script</span></div><div class="line">    name=db_hue</div><div class="line">    <span class="comment">## options=&#123;&#125;</span></div><div class="line"><span class="comment"># 3</span></div><div class="line">  [[hdfs_clusters]]</div><div class="line">    <span class="comment"># HA support by using HttpFs</span></div><div class="line"></div><div class="line">    [[[default]]]</div><div class="line">      <span class="comment"># Enter the filesystem uri</span></div><div class="line">      fs_defaultfs=hdfs://xxx:8020</div><div class="line">      hadoop_conf_dir=xxx</div><div class="line"><span class="comment">#4</span></div><div class="line">[beeswax]</div><div class="line">  hive_server_host=xxx.xxx.xxx.xxx</div><div class="line">  hive_server_port=10000</div><div class="line"><span class="comment">#5</span></div><div class="line">[librdbms]</div><div class="line">  [[databases]]</div><div class="line">     [[[mysql_1]]]</div><div class="line">       nice_name=<span class="string">"xxx"</span></div><div class="line">       name=xxx</div><div class="line">       host=xxx.xxx.xxx.xxx</div><div class="line">       port=3306</div><div class="line">       user=root</div><div class="line">       password=xxx</div><div class="line">       options=&#123;<span class="string">"charset"</span>:<span class="string">"utf8"</span>&#125;</div></pre></td></tr></table></figure></p>
<h3 id="mysql执行建数据库命令"><a href="#mysql执行建数据库命令" class="headerlink" title="mysql执行建数据库命令"></a>mysql执行建数据库命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql -hhost -uroot -pxxx</div><div class="line">&gt; create database db_hue;</div><div class="line">&gt; <span class="built_in">exit</span>;</div><div class="line">./build/env/bin/hue syncdb</div><div class="line">./build/env/bin/hue migrate</div></pre></td></tr></table></figure>
<h3 id="启动Hue"><a href="#启动Hue" class="headerlink" title="启动Hue"></a>启动Hue</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./build/env/bin/supervisor</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/13/分组TopN问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/13/分组TopN问题/" itemprop="url">分组TopN问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-13T15:02:21+08:00">
                2017-03-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h3><p>列说明:<br>菜名 省份名 市场名 价格<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">v2 p2 m7 2.2</div><div class="line">v2 p2 m8 2.4</div><div class="line">v1 p1 m8 1</div><div class="line">v1 p1 m9 1.2</div><div class="line">v1 p2 m10 1.3</div><div class="line">v1 p2 m11 1.4</div><div class="line">v2 p1 m9 2</div><div class="line">v2 p1 m10 3</div><div class="line">v2 p1 m11 5</div><div class="line">v2 p2 m12 2.2</div><div class="line">v2 p2 m13 2.4</div></pre></td></tr></table></figure></p>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>一、对于每种菜，求出比全国平均价更高的省份<br>(解释：每种菜都有全国平均价格，每种菜在不同省也有不同的平均价格，找到比全国平均价高的省份)<br>二、对于上面的省份，求出比全国平均价高的每种菜的Top3的市场</p>
<h3 id="Spark任务"><a href="#Spark任务" class="headerlink" title="Spark任务"></a>Spark任务</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">test_data_spark</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="type">Logger</span>.getLogger(<span class="string">"org"</span>).setLevel(<span class="type">Level</span>.<span class="type">WARN</span>)</div><div class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"test"</span>).setMaster(<span class="string">"local"</span>)</div><div class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</div><div class="line">    <span class="keyword">val</span> rdd = sc.textFile(<span class="string">"./src/test/test_data"</span>).cache()</div><div class="line">    <span class="keyword">val</span> v_p_avg_price = rdd.map(x =&gt; &#123;</div><div class="line">      <span class="keyword">val</span> line = x.split(<span class="string">" "</span>)</div><div class="line">      (line(<span class="number">0</span>)+<span class="string">"#"</span>+line(<span class="number">1</span>), (line(<span class="number">3</span>).toFloat, <span class="number">1</span>))</div><div class="line">    &#125;).reduceByKey((x, y) =&gt; (x._1+y._1, x._2+y._2)).mapValues(x =&gt; x._1/x._2).cache()</div><div class="line">    <span class="comment">/*</span></div><div class="line">    v_p_avg_price 是求出每种菜的每个省份的 平均价格</div><div class="line">    (v2#p2,2.3000002)</div><div class="line">    (v1#p1,1.5666666)</div><div class="line">    (v1#p2,1.3499999)</div><div class="line">    (v2#p1,3.3333333)</div><div class="line">    */</div><div class="line">    <span class="keyword">val</span> v_avg_price = v_p_avg_price.map(x =&gt;</div><div class="line">      (x._1.split(<span class="string">"#"</span>)(<span class="number">0</span>), (x._2, <span class="number">1</span>))).reduceByKey((x, y) =&gt; (x._1+y._1, x._2+y._2)).mapValues(x =&gt; x._1/x._2)</div><div class="line">    <span class="comment">/*</span></div><div class="line">    v_avg_price 是每种菜的全国平均价格</div><div class="line">    (v1,1.4583333)</div><div class="line">    (v2,2.8166666)</div><div class="line">    * */</div><div class="line">    <span class="keyword">val</span> nn_v_p_avg_price = v_p_avg_price.map(x =&gt; (x._1.split(<span class="string">"#"</span>)(<span class="number">0</span>), (x._1.split(<span class="string">"#"</span>)(<span class="number">1</span>), x._2)))</div><div class="line">    <span class="keyword">val</span> higer_p = nn_v_p_avg_price.join(v_avg_price).map(x =&gt; &#123;</div><div class="line">      <span class="keyword">if</span>(x._2._1._2 &gt; x._2._2)&#123;</div><div class="line">        (x._1, x._2._1._1)</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        (<span class="string">"NULL"</span>, <span class="string">"NULL"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;).filter(x =&gt; ! x._1.contains(<span class="string">"NULL"</span>)).map(x =&gt; (x._1 + <span class="string">"#"</span> + x._2, <span class="number">0</span>))</div><div class="line">    <span class="comment">/*</span></div><div class="line">    higer_p 是对于每种菜，求出比全国平均价更高的省份</div><div class="line">    (v1#p1,0)</div><div class="line">    (v2#p1,0)</div><div class="line">    * */</div><div class="line">    <span class="keyword">val</span> wait_filter_data = rdd.map(x =&gt; &#123;</div><div class="line">      <span class="keyword">val</span> line = x.split(<span class="string">" "</span>)</div><div class="line">      (line(<span class="number">0</span>)+<span class="string">"#"</span>+line(<span class="number">1</span>), line(<span class="number">2</span>)+<span class="string">"#"</span>+line(<span class="number">3</span>))</div><div class="line">    &#125;)</div><div class="line">    higer_p.join(wait_filter_data).groupByKey().mapValues(x =&gt; &#123;</div><div class="line">      x.toList.map(x =&gt; &#123;</div><div class="line">        <span class="keyword">val</span> line = x._2.split(<span class="string">"#"</span>)</div><div class="line">        (line(<span class="number">0</span>), line(<span class="number">1</span>))</div><div class="line">      &#125;).sortBy(x =&gt; -x._2.toDouble).take(<span class="number">3</span>) <span class="comment">// ===分组求TopN操作 先groupByKey-&gt;sortBy-&gt;take===</span></div><div class="line">    &#125;).foreach(println _)</div><div class="line">    <span class="comment">/*</span></div><div class="line">    最后结果</div><div class="line">    (v1#p1,List((m5,3), (m4,2), (m2,1.2)))   m5是最高的，接下来m4, m2</div><div class="line">    (v2#p1,List((m5,5), (m6,5), (m11,5)))</div><div class="line">    * */</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<img src="/images/201703/groupby_topN_1.png">
<h3 id="SparkSQL任务-（Hive窗口函数）"><a href="#SparkSQL任务-（Hive窗口函数）" class="headerlink" title="SparkSQL任务 （Hive窗口函数）"></a>SparkSQL任务 （Hive窗口函数）</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">test_data_SparkSql</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="type">Logger</span>.getLogger(<span class="string">"org"</span>).setLevel(<span class="type">Level</span>.<span class="type">WARN</span>)</div><div class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"test"</span>).setMaster(<span class="string">"local"</span>)</div><div class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</div><div class="line">    <span class="keyword">val</span> <span class="type">Hivectx</span> = <span class="keyword">new</span> <span class="type">HiveContext</span>(sc)</div><div class="line">    <span class="type">Hivectx</span>.sql(<span class="string">"DROP TABLE IF EXISTS LOG"</span>)</div><div class="line">    <span class="type">Hivectx</span>.sql(<span class="string">"CREATE TABLE IF NOT EXISTS LOG (v STRING,p STRING,m STRING, price FLOAT) row format delimited fields terminated by ' '"</span>)</div><div class="line">    <span class="type">Hivectx</span>.sql(<span class="string">"LOAD DATA LOCAL INPATH './src/test/test_data' INTO TABLE LOG"</span>)</div><div class="line">    <span class="type">Hivectx</span>.sql(<span class="string">"DROP TABLE IF EXISTS higher_p"</span>)</div><div class="line">    <span class="comment">//以上是将输入源导入Hive表中</span></div><div class="line"></div><div class="line">    <span class="type">Hivectx</span>.sql(<span class="string">"create table IF NOT EXISTS higher_p as select b.v, b.p from( select v, avg(price) price from log "</span> +</div><div class="line">      <span class="string">"group by v)a join (select v, p, avg(price) price from log group by v, p)b on a.v = b.v where b.price &gt; a.price"</span>)</div><div class="line">    <span class="comment">//上一部是找到  对于每种菜，求出比全国平均价更高的省份</span></div><div class="line"></div><div class="line">    <span class="keyword">val</span> result = <span class="type">Hivectx</span>.sql(<span class="string">"select * from(select b.v as v, b.p as p, b.m as m, b.price as price, row_number() OVER(PARTITION by b.v, b.p order by b.price desc) as rank from higher_p a join log b on a.v = b.v and a.p = b.p )c where c.rank &lt;= 3"</span>)</div><div class="line">    <span class="comment">//上一部是找到  对于上面的省份，求出比全国平均价高的每种菜的Top3的市场</span></div><div class="line">    <span class="comment">// 用到row_number 窗口函数（PS. 因为用到窗口函数，需要把表放到Hive中，不能建立临时表操作）</span></div><div class="line">    result.foreach(println _)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<img src="/images/201703/groupby_topN_2.png">
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/10/SparkStreaming和Kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/10/SparkStreaming和Kafka/" itemprop="url">SparkStreaming+Kafka Receiver到DirectApi</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-10T14:10:42+08:00">
                2017-03-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/images/201703/SparkStreaming_Kafka_1.png">
<h3 id="Receiver到DirectApi-优点"><a href="#Receiver到DirectApi-优点" class="headerlink" title="Receiver到DirectApi 优点"></a>Receiver到DirectApi 优点</h3><ul>
<li>没有WAL，减少了存储和增快了性能(从kafka直接获取数据，比从hdfs快)</li>
<li>自己维护Offset，实现了exactly-one</li>
</ul>
<h3 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h3><ul>
<li>offset不通过zk维护，不能在监控工具上查看offset</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/01/SparkStreaming的window操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/01/SparkStreaming的window操作/" itemprop="url">SparkStreaming的window操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-01T21:38:12+08:00">
                2017-03-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="简单介绍window操作"><a href="#简单介绍window操作" class="headerlink" title="简单介绍window操作"></a>简单介绍window操作</h3><img src="/images/201703/SparkStreaming_window_1.png">
<p><strong>原始的Dstream</strong>：一个参数，表示多长时间划分一个RDD<br><strong>窗口操作</strong>：两个参数，表示</p>
<ul>
<li>window length（窗口长度）：窗口的持续时间（上图为3个时间单位）</li>
<li>sliding interval （滑动间隔）- 窗口操作的时间间隔（上图为2个时间单位）</li>
</ul>
<p><strong>对上图简单理解：每隔2个时间单位，对之前的3个时间单位操作</strong></p>
<h3 id="API说明"><a href="#API说明" class="headerlink" title="API说明"></a>API说明</h3><p>举例：<br>SparkStreaming的输入：每秒从[aa,bb,cc,dd,ee,ff,gg,hh]中随机选一个作为输入<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sc,<span class="type">Seconds</span>(<span class="number">1</span>))</div><div class="line"><span class="keyword">val</span> socketStreaming = ssc.socketTextStream(<span class="string">"master"</span>,<span class="number">9999</span>)</div></pre></td></tr></table></figure></p>
<h4 id="window"><a href="#window" class="headerlink" title="window"></a>window</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> data = socketStreaming.window(<span class="type">Seconds</span>(<span class="number">3</span>), <span class="type">Seconds</span>(<span class="number">2</span>))</div><div class="line">data.print()</div></pre></td></tr></table></figure>
<p>结果如图：<br><img src="/images/201703/SparkStreaming_window_2.png"></p>
<h4 id="countByValueAndWindow"><a href="#countByValueAndWindow" class="headerlink" title="countByValueAndWindow"></a>countByValueAndWindow</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> data = socketStreaming.countByValueAndWindow(<span class="type">Seconds</span>(<span class="number">3</span>),<span class="type">Seconds</span>(<span class="number">2</span>))</div><div class="line">data.print()</div></pre></td></tr></table></figure>
<img src="/images/201703/SparkStreaming_window_3.png">
<h4 id="reduceByKeyAndWindow"><a href="#reduceByKeyAndWindow" class="headerlink" title="reduceByKeyAndWindow"></a>reduceByKeyAndWindow</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> data = socketStreaming.map(x=&gt;(x,<span class="number">1</span>)).</div><div class="line">    reduceByKeyAndWindow(</div><div class="line">    _+_, <span class="comment">// 加上新进入窗口的新批次中的元素 </span></div><div class="line">    _-_, <span class="comment">// 减去离开窗口的的老批次的元素</span></div><div class="line">    <span class="type">Seconds</span>(<span class="number">3</span>),<span class="type">Seconds</span>(<span class="number">2</span>))</div><div class="line">data.print()</div></pre></td></tr></table></figure>
<img src="/images/201703/SparkStreaming_window_4.png">
<ul>
<li>reduceByKeyAndWindow(func,windowLength, slideInterval, [numTasks])</li>
<li>reduceByKeyAndWindow(func, invFunc,windowLength, slideInterval, [numTasks])</li>
<li>使用逆函数invFunc可以提高效率</li>
<li><img src="/images/201703/SparkStreaming_reduceByKeyAndWindow_1.png"></li>
<li><img src="/images/201703/SparkStreaming_reduceByKeyAndWindow_2.png">
</li>
</ul>
<h4 id="reduceByWindow和countByWindow"><a href="#reduceByWindow和countByWindow" class="headerlink" title="reduceByWindow和countByWindow"></a>reduceByWindow和countByWindow</h4><p>暂时没看明白,mark</p>
<p>PS.在今天面试之前，面试官竟然看了我的博客，还是很开心的～</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/28/MapReduce调优简单总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiwu1212@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Refrain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/28/MapReduce调优简单总结/" itemprop="url">MapReduce调优简单总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-28T13:57:14+08:00">
                2017-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/images/201702/mr_optimize_1.png">
<table>
<thead>
<tr>
<th>选项</th>
<th>类型</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>mapreduce.map.memory.mb</td>
<td>int</td>
<td>1024</td>
<td>map使用的内存</td>
</tr>
<tr>
<td>mapred.min.split.size</td>
<td>int</td>
<td>1</td>
<td>Input Split的最小值</td>
</tr>
<tr>
<td>mapred.map.tasks</td>
<td>int</td>
<td>1</td>
<td>Map Task的数量</td>
</tr>
<tr>
<td>io.sort.mb</td>
<td>int</td>
<td>100</td>
<td>map缓冲区大小</td>
</tr>
<tr>
<td>io.sort.factor</td>
<td>int</td>
<td>10</td>
<td>并行处理spill的个数</td>
</tr>
<tr>
<td>min.num.spill.for.combine</td>
<td>int</td>
<td>3</td>
<td>最少有3个Spill文件需要Merge时，执行combine操作</td>
</tr>
<tr>
<td>mapred.compress.map.output</td>
<td>boolean</td>
<td>false</td>
<td>map中间数据是否采用压缩</td>
</tr>
<tr>
<td>mapred.map.output.compression.codec</td>
<td>String</td>
<td>.</td>
<td>压缩算法</td>
</tr>
</tbody>
</table>
<img src="/images/201702/mr_optimize_2.png">
<table>
<thead>
<tr>
<th>选项</th>
<th>类型</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>mapreduce.reduce.memory.mb</td>
<td>int</td>
<td>1024</td>
<td>reduce使用的内存</td>
</tr>
<tr>
<td>mapred.reduce.parallel.copies</td>
<td>int</td>
<td>5</td>
<td>每个reduce去map中拿数据的并行数</td>
</tr>
<tr>
<td>mapred.reduce.copy.backoff</td>
<td>int</td>
<td>300</td>
<td>获取map数据最大超时时间</td>
</tr>
<tr>
<td>mapred.job.shuffle.input.buffer.percent</td>
<td>float</td>
<td>0.7</td>
<td>buffer大小占reduce可用内存的比例</td>
</tr>
<tr>
<td>mapred.child.java.opts</td>
<td>String</td>
<td>.</td>
<td>-Xmx1024m设置reduce可用内存为1g</td>
</tr>
<tr>
<td>mapred.job.shuffle.merge.percent</td>
<td>float</td>
<td>0.66</td>
<td>buffer中的数据达到多少比例开始写入磁盘</td>
</tr>
<tr>
<td>mapred.job.reduce.input.buffer.percent</td>
<td>float</td>
<td>0.0</td>
<td>指定多少比例的内存用来存放buffer中的数据</td>
</tr>
</tbody>
</table>
<p>一个通用的原则是给shuffle过程分配尽可能大的内存。<br>运行map和reduce任务的JVM，内存通过mapred.child.java.opts属性来设置，尽可能设大内存。<br>容器的内存大小通过mapreduce.map.memory.mb和mapreduce.reduce.memory.mb来设置，默认都是1024M。<br>Hadoop默认使用4KB作为缓冲，这个算是很小的，可以通过io.file.buffer.size来调高缓冲池大小。</p>
<p>Map Task和Reduce Task调优的一个原则就是<br>减少数据的传输量 =&gt; 预聚合combine<br>尽量使用内存 =&gt; 提高内存使用(1、map环形缓冲区 2、reduce的Merge阶段)<br>减少磁盘IO的次数 =&gt; 增加Spill大小<br>增大任务并行数 =&gt; Reduce数量，Map数量</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="xiwu1212@163.com" />
          <p class="site-author-name" itemprop="name">xiwu1212@163.com</p>
           
              <p class="site-description motion-element" itemprop="description">学无止境</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiwu1212@163.com</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

  

</body>
</html>
